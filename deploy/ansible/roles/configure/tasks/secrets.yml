- name: ensure secret destination folders exist
  command: mkdir -p {{item.dest | dirname}}
  args:
    creates: "{{item.dest | dirname}}"
  with_items: secret_files

- name: copy files from secret server to remote via local machine
  sudo: false
  local_action: |
    shell scp -3 -r \
    {{disable_host_key_checking | default("")}} \
    {{secret_user}}@{{secret_server}}:{{secret_path}}/{{item.src}} \
    {{secret_user}}@{{site_fqdn}}:~/
  args:
    creates: "~{{item.src}}"
  with_items: secret_files

- name: move secrets on remote machine to destination
  command: mv ~{{secret_user}}/{{item.src}} {{item.dest}}
  args:
    creates: "{{item.dest}}"
  with_items: secret_files
